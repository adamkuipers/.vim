Printstagram.Routers.SelectorApp = Backbone.Router.extend({
      
      <% products = Product.all %>
        routes: {
              <% products.each do |p| %>
                    "<%=p.short_name%>":"<%=p.short_name%>",
                        <% end %>
                            "": "index"
                              },

                                main: function(productData){
                                      var photos, selector, navigation, followings;

                                          var vent = _.extend({}, Backbone.Events);

                                              this.state = { count: 0 }
                                                  self = this;

                                                      selects = this.getSelects();

                                                          

                                                          select_header = new SelectorApp.Views.SelectHeader({ vent: vent,
                                                                    productData: productData, state: this.state, selects: selects });

                                                                    followings = new SelectorApp.Collections.Followings();
                                                                        followings.fetch({
                                                                                  success: function(followings) {
                                                                                            $.getJSON('/api/instagram/self_media_count', function(media) {
                                                                                                        console.log(media);
                                                                                                                  self.navigation = new SelectorApp.Views.Navigation({ vent: vent, 
                                                                                                                                  followings: followings, media: media });
                                                                                                                                      });
                                                                                                                                            }
                                                                                                                                                });

                                                                                                                                                    photos = new SelectorApp.Collections.InstagramPhotos();
                                                                                                                                                        photos.fetch({
                                                                                                                                                                  success: function(photos) {
                                                                                                                                                                            console.log(photos);
                                                                                                                                                                                    self.selector = new Printstagram.Views.SelectorApp({ followings: followings, 
                                                                                                                                                                                                  vent: vent, photos: photos, state: self.state });
                                                                                                                                                                                                    }
                                                                                                                                                                                                        });
                                                                                                                                                                                                          },

                                                                                                                                                                                                            <% products.each do |p| %>
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  <%=p.short_name%>: function() {
                                                                                                                                                                                                                        var productData = {
                                                                                                                                                                                                                                "name": "<%=p.name%>",
                                                                                                                                                                                                                                      "maxCount": <%=p.max_photos%>,
                                                                                                                                                                                                                                            "id": <%=p.id%>
                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                    this.main(productData);
                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                          <% end %>

                                                                                                                                                                                                                                                            index: function(){
                                                                                                                                                                                                                                                                  $('#main').append(
                                                                                                                                                                                                                                                                          'Choose a product!<p>'
                                                                                                                                                                                                                                                                                <% products.each do |p| %>
                                                                                                                                                                                                                                                                                         + '<a href = "#" id = "<%=p.short_name%>" class = "link"><%=p.name%></a><p>'
                                                                                                                                                                                                                                                                                               <% end %>);
                                                                                                                                                                                                                                                                                                 $('.link').click(function(e){
                                                                                                                                                                                                                                                                                                         e.preventDefault();
                                                                                                                                                                                                                                                                                                               Backbone.history.navigate('#' + $(e.target).attr('id'),{trigger: true});
                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                       );
                                                                                                                                                                                                                                                                                                                         },

                                                                                                                                                                                                                                                                                                                           getSelects: function(){
                                                                                                                                                                                                                                                                                                                                 selects = new Hashtable();
                                                                                                                                                                                                                                                                                                                                     if ($.cookies.get('current_order') != undefined ){
                                                                                                                                                                                                                                                                                                                                             $.ajax({
                                                                                                                                                                                                                                                                                                                                                         type: 'GET',
                                                                                                                                                                                                                                                                                                                                                                 url: '/api/orders/get_order_contents',
                                                                                                                                                                                                                                                                                                                                                                         dataType: 'json',
                                                                                                                                                                                                                                                                                                                                                                                 success: function(contents){
                                                                                                                                                                                                                                                                                                                                                                                             for(var i = 0; i < contents.length; i++){
                                                                                                                                                                                                                                                                                                                                                                                                           self.state.count += contents[i].copies;
                                                                                                                                                                                                                                                                                                                                                                                                                       selects.put(contents[i].photo_id,contents[i].copies);
                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                         },
                                                                                                                                                                                                                                                                                                                                                                                                                                                 async: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                       });
                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                               return selects;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
});
